<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Ver POIs</title>
</head>
<body>
  <h2>Consultar POIs por Coordenadas</h2>

  <form id="poiForm">
    <label for="lat">Latitude:</label>
    <input type="text" id="lat" name="lat" required /><br /><br />

    <label for="lon">Longitude:</label>
    <input type="text" id="lon" name="lon" required /><br /><br />

    <button type="submit">Pesquisar</button>
  </form>

  <h3>Freguesia:</h3>
  <pre id="freguesia"></pre>

  <h3>POIs:</h3>
  <div id="pois"></div>

  <script>
    document.getElementById("poiForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);

      document.getElementById("freguesia").textContent = "A procurar freguesia...";
      document.getElementById("pois").innerHTML = "";

      try {
        // Obter freguesia
        const freguesiaResponse = await fetch(`/api/freguesia?lat=${lat}&lon=${lon}`);
        const freguesiaData = await freguesiaResponse.json();
        document.getElementById("freguesia").textContent = JSON.stringify(freguesiaData, null, 2);

        // Obter POIs
        const poisResponse = await fetch("/api/pois", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat, lon })
        });
        const poisData = await poisResponse.json();

        const poisContainer = document.getElementById("pois");

        for (const poi of poisData) {
          const div = document.createElement("div");
            div.style.border = "1px solid #ccc";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";
            div.style.borderRadius = "6px";
            div.style.backgroundColor = "#f9f9f9";
                    
            let html = `<strong>${poi.descr_poi}</strong><br/>`;
            html += `<em>${poi.descr_categoria} / ${poi.descr_subcategoria}</em><br/>`;
            html += `<small>${poi.descr_entidade}</small><br/>`;
                    
            div.innerHTML = html;
          const pre = document.createElement("pre");
          pre.textContent = html;
          div.appendChild(pre);

          // Se for da categoria "Educação", buscar estatísticas
          if (poi.descr_subcategoria === "Escola") {
            const estatPre = document.createElement("pre");
            estatPre.textContent = "Carregando estatísticas...";
            div.appendChild(estatPre);

            try {
              const estatRes = await fetch(`/api/escolas/${poi.id_poi}`);
              if (estatRes.ok) {
                const estat = await estatRes.json();
                if (estat.estatisticas.length > 0) {
                  estatPre.textContent = estat.estatisticas.map(e =>
                    `  - Ciclo: ${e.descr_ciclo_escolar}\n` +
                    `  - Média: ${e.media_global}\n` +
                    `  - Ranking Nacional: ${e.ranking_nacional}\n` +
                    `  - Ranking Distrital: ${e.ranking_distrital}\n`
                  ).join("\n");
                } else {
                  estatPre.textContent = "Sem estatísticas disponíveis.";
                }
              } else {
                estatPre.textContent = "Erro ao carregar estatísticas.";
              }
            } catch {
              estatPre.textContent = "Erro ao carregar estatísticas.";
            }
          }

          poisContainer.appendChild(div);
        }

      } catch (error) {
        document.getElementById("freguesia").textContent = "Erro ao obter freguesia.";
        document.getElementById("pois").innerHTML = `<pre>Erro ao obter POIs: ${error.message}</pre>`;
      }
    });
  </script>
</body>
</html>
